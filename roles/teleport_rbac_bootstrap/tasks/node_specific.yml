- name: Create the Teleport objects dir
  ansible.builtin.file:
    path: /root/teleport-objects
    state: directory
    mode: "0755"
    owner: root

- name: Copy the teleport object files to the teleport host
  loop:
    - role-cmc-editor.yaml
    - role-host-certifier.yaml
    - role-kube-admin.yaml
    - role-kube-user.yaml
    - cmc.yaml
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/root/teleport-objects/{{ item }}"
    mode: "0644"
    owner: root

- name: Template the admin user
  loop:
    - user-teleport-admin.yaml
  ansible.builtin.template:
    dest: "/root/teleport-objects/{{ item }}"
    src: "{{ item }}.j2"
    mode: "0755"

- name: Check if admin user needs to be reset (before creating it)
  changed_when: false
  failed_when: false
  register: tctl_get_admin_user
  ansible.builtin.command:
    cmd: "tctl get user/teleport-admin"


- name: Create the objects
  loop:
    - role-cmc-editor.yaml
    - role-host-certifier.yaml
    - role-kube-admin.yaml
    - role-kube-user.yaml
    - cmc.yaml
    - user-teleport-admin.yaml
  changed_when: true
  ansible.builtin.command:
    cmd: "tctl create -f /root/teleport-objects/{{ item }}"

- name: Reset admin user
  when: tctl_get_admin_user.rc != 0
  changed_when: true
  ansible.builtin.command:
    cmd: "tctl users reset teleport-admin"
